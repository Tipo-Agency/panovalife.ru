name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          VITE_CALLTOUCH_API_TOKEN: ${{ secrets.VITE_CALLTOUCH_API_TOKEN }}
      
      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist directory not found"
            exit 1
          fi
          echo "‚úÖ Build successful: $(du -sh dist | cut -f1)"
          ls -la dist/
      
      - name: Deploy build files to server (full overwrite)
        run: |
          echo "üöÄ Starting deployment..."
          
          # Validate secrets
          if [ -z "${{ secrets.SERVER_USER }}" ] || [ -z "${{ secrets.SERVER_HOST }}" ] || [ -z "${{ secrets.SERVER_PATH }}" ] || [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "‚ùå Error: Missing required secrets"
            echo "Required: SERVER_USER, SERVER_HOST, SERVER_PATH, SERVER_SSH_KEY"
            exit 1
          fi
          
          # Setup SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Save SSH key with proper formatting
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Verify SSH key format
          if ! head -1 ~/.ssh/deploy_key | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "‚ö†Ô∏è  Warning: SSH key might not be in correct format"
            head -1 ~/.ssh/deploy_key
          fi
          
          # Add server to known_hosts
          echo "üîç Adding server to known_hosts..."
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>&1 || echo "‚ö†Ô∏è  ssh-keyscan failed, continuing..."
          chmod 644 ~/.ssh/known_hosts
          
          # Test SSH connection with retry
          echo "üîå Testing SSH connection..."
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."
            if timeout 15 ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              echo "SSH connection successful"; then
              echo "‚úÖ SSH connection established"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "‚ùå SSH connection test failed after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "‚ö†Ô∏è  Connection failed, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            fi
          done
          
          # Deploy with rsync and retry
          echo "üì¶ Syncing files to server..."
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Deployment attempt $i of $MAX_RETRIES..."
            if rsync -azv --delete --progress \
              -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=10" \
              dist/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/; then
              echo "‚úÖ Deployment completed successfully!"
              exit 0
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "‚ùå Deployment failed after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "‚ö†Ô∏è  Deployment failed, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            fi
          done
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "üßπ Cleanup completed"
